// ‚úÖ script.js avec logique corrig√©e : affichage m√©moire, clic limit√©, interactions actives

let playerCards = [], botCards = [], discardPile = [], drawnCard = null;
let targetScore = 3;
let specialAction = null;
let jackSwapSelectedIndex = null;
let startVisibleCount = 2, cardCount = 4, currentPlayer = "Toi", revealedIndexes = [];
let selectingInitialCards = false;

const CARD_POOL = ["R", "A", 2, 3, 4, 5, 6, 7, 8, 9, 10, "V", "D"];
const log = (msg) => {
    document.getElementById("log").innerHTML += `<p>${msg}</p>`;
    console.log(msg);
};

function login() {
    const username = document.getElementById("username").value.trim();
    if (!username) return alert("Entre un pseudo pour continuer.");
    sessionStorage.setItem("username", username);
    document.getElementById("welcome").style.display = "none";
    document.getElementById("config").style.display = "block";
    document.getElementById("player-name").innerText = username;
    log(`üëã Bienvenue, ${username} !`);
}

function safeCreateRoom() {
    log("üß™ Cr√©ation fictive d'une partie...");
    document.getElementById("config").style.display = "none";
    document.getElementById("lobby").style.display = "block";
    document.getElementById("lobby-room").innerText = "TEST123";
    document.getElementById("lobby-players").innerHTML = `<li>Toi (h√¥te)</li><li>Bot</li>`;
    document.getElementById("btn-launch-setup").style.display = "inline-block";
}

function joinRoom() {
    log("üß™ Rejoint fictivement une partie...");
    document.getElementById("config").style.display = "none";
    document.getElementById("lobby").style.display = "block";
    document.getElementById("lobby-room").innerText = "TEST123";
    document.getElementById("lobby-players").innerHTML = "<li>Bot (h√¥te)</li><li>Toi</li>";
    // D√©marrage automatique de la configuration
    setTimeout(() => {
        log("üö¶ Le bot lance la configuration de la partie...");
        launchSetup();
    }, 2000);
}

function launchSetup() {
    document.getElementById("lobby").style.display = "none";
    document.getElementById("setup").style.display = "block";
}

function saveGameConfig() {
    startVisibleCount = parseInt(document.getElementById("visible-count").value);
    cardCount = parseInt(document.getElementById("card-count").value);
    targetScore = parseInt(document.getElementById("target-score").value);
    log(`üíæ Config sauvegard√©e (Cartes: ${cardCount}, Visibles: ${startVisibleCount}, Cible: ${targetScore})`);
}

function startNewGame() {
    document.getElementById("setup").style.display = "none";
    document.getElementById("game").style.display = "block";
    playerCards = Array.from({ length: cardCount }, () => CARD_POOL[Math.floor(Math.random() * CARD_POOL.length)]);
    botCards = Array.from({ length: cardCount }, () => CARD_POOL[Math.floor(Math.random() * CARD_POOL.length)]);
    console.log("Contenu de botCards apr√®s la distribution :", botCards); // AJOUT√â POUR V√âRIFICATION
    revealedIndexes = [];
    selectingInitialCards = true;
    drawnCard = null;
    specialAction = null;
    jackSwapSelectedIndex = null;
    document.getElementById("skip-special").style.display = "none";
    currentPlayer = "Toi";
    log(`üÉè S√©lectionne ${startVisibleCount} carte(s) √† regarder.`);
    renderCards();
    updateTurn();
}

function drawCard() {
    if (selectingInitialCards) return log("‚è≥ Termine d'abord ta s√©lection de cartes m√©moire.");
    if (currentPlayer !== "Toi") return log("‚õî Ce n'est pas ton tour !");
    drawnCard = CARD_POOL[Math.floor(Math.random() * CARD_POOL.length)];
    log(`üÉè Carte pioch√©e : ${drawnCard}`);
    showDrawnCard();
}

function showDrawnCard() {
    const drawnDiv = document.getElementById("drawn-card");
    drawnDiv.style.display = "block";
    document.getElementById("new-card").innerText = drawnCard;
    if (!document.getElementById("discard-drawn")) {
        const btn = document.createElement("button");
        btn.id = "discard-drawn";
        btn.innerText = "D√©fausser la carte";
        btn.onclick = discardDrawnCard;
        drawnDiv.after(btn);
    }
}

function discardDrawnCard() {
    if (drawnCard === null) return;
    discardPile.push(drawnCard);
    log(`üóë Carte pioch√©e d√©fauss√©e : ${drawnCard}`);
    checkSpecialEffect(drawnCard);
    if (!specialAction) if (!specialAction) endPlayerTurn();
    drawnCard = null;
    document.getElementById("drawn-card").style.display = "none";
    document.getElementById("discard-drawn")?.remove();
    renderCards();
    drawnCard = null;
    document.getElementById("drawn-card").style.display = "none";
    document.getElementById("discard-drawn")?.remove();
    renderCards();
    endPlayerTurn();
}

function attemptCardSwap(index) {
    if (drawnCard === null) return;
    const oldCard = playerCards[index];
    playerCards[index] = drawnCard;
    drawnCard = null;
    discardPile.push(oldCard);
    log(`üîÑ Carte √©chang√©e : ${oldCard} ‚Üí ${playerCards[index]}`);
    checkSpecialEffect(oldCard);
    if (!specialAction) endPlayerTurn();
    document.getElementById("drawn-card").style.display = "none";
    document.getElementById("discard-drawn")?.remove();
    renderCards();
}

function discardCardFromHand(index) {
    const card = playerCards[index];
    const topDiscard = discardPile[discardPile.length - 1];
    const normalize = (val) => (typeof val === "number" ? val : isNaN(val) ? val : parseInt(val));

    // Cas 1 : d√©fausse rapide (hors de ton tour)
    if (currentPlayer !== "Toi") {
        if (!topDiscard) return log("‚ùå Aucune carte dans la d√©fausse.");

        if (normalize(card) === normalize(topDiscard)) {
            playerCards.splice(index, 1);
            discardPile.push(card);
            log(`‚ö° Vous d√©faussez rapidement votre carte ${card} qui correspond √† la d√©fausse !`);
            checkSpecialEffect(card);
        } else {
            const penaltyCard = CARD_POOL[Math.floor(Math.random() * CARD_POOL.length)];
            playerCards.push(penaltyCard);
            log(`‚ùå Mauvaise tentative de d√©fausse √©clair. Vous piochez une carte de p√©nalit√© (${penaltyCard}).`);
        }
        renderCards();
        return;
    }

    // Cas 2 : c'est ton tour
    if (drawnCard !== null) {
        return log("‚è≥ Vous devez d'abord jouer ou d√©fausser la carte pioch√©e.");
    }

    // D√©fausse volontaire
    discardPile.push(card);
    playerCards[index] = CARD_POOL[Math.floor(Math.random() * CARD_POOL.length)];
    log(`üóë D√©fausse volontaire de la carte ${card}`);
    checkSpecialEffect(card);
    if (!specialAction) endPlayerTurn();
    renderCards();
}

function initiateDiscardSwap() {
    if (currentPlayer !== "Toi") return log("‚õî Ce n'est pas ton tour !");
    if (discardPile.length === 0) return log("‚ùå Aucune carte dans la d√©fausse");
    drawnCard = discardPile.pop();
    log(`üîÅ Carte r√©cup√©r√©e de la d√©fausse : ${drawnCard}`);
    showDrawnCard();
}

function renderCards() {
    const handDiv = document.getElementById("player-hand");
    handDiv.innerHTML = "<h3>Ton jeu</h3>";

    playerCards.forEach((card, i) => {
        const wrap = document.createElement("div");
        wrap.className = "card-wrapper";
        const c = document.createElement("div");
        c.className = "card";

        if (selectingInitialCards) {
            c.classList.add("selectable-start");
            c.innerText = revealedIndexes.includes(i) ? card : "?";
            if (revealedIndexes.includes(i)) {
                c.classList.add("highlight");
            }
            c.onclick = () => {
                if (revealedIndexes.length >= startVisibleCount || revealedIndexes.includes(i)) return;
                revealedIndexes.push(i);
                renderCards();
                if (revealedIndexes.length === startVisibleCount) {
                    log("üëÄ Cartes s√©lectionn√©es. Affichage temporaire...");
                    setTimeout(() => {
                        selectingInitialCards = false;
                        renderCards();
                        log("üïë Cartes de nouveau cach√©es.");
                    }, 5000);
                }
            };
        } else {
            c.innerText = revealedIndexes.includes(i) ? card : "?";
            if (revealedIndexes.includes(i)) {
                c.classList.add("highlight");
            }
            c.onclick = () => handleCardClick(i, card);
        }

        wrap.appendChild(c);
        handDiv.appendChild(wrap);
    });

    renderBotCards(); // S'ASSURER QUE C'EST BIEN APPEL√â ICI
}

function renderBotCards() {
    const botDiv = document.getElementById("opponent-hand");
    botDiv.innerHTML = "<h3>Adversaire</h3>";

    botCards.forEach((card, i) => {
        const wrap = document.createElement("div");
        wrap.className = "card-wrapper";

        const c = document.createElement("div");
        c.className = "card";
        c.innerText = "?";

        if (specialAction === "lookOpp") {
            c.onclick = () => {
                log(`üëÅÔ∏è Carte du bot en position ${i + 1} : ${card}`);
                specialAction = null;
                document.getElementById("skip-special").style.display = "none";
                renderCards();
                endPlayerTurn();
            };
        } else if (specialAction === "swapJack" && jackSwapSelectedIndex !== null) {
            c.onclick = () => {
                const temp = botCards[i];
                botCards[i] = playerCards[jackSwapSelectedIndex];
                playerCards[jackSwapSelectedIndex] = temp;
                log(`üîÑ Vous √©changez votre carte en position ${jackSwapSelectedIndex + 1} avec celle du bot.`);
                specialAction = null;
                jackSwapSelectedIndex = null;
                document.getElementById("skip-special").style.display = "none";
                renderCards();
                endPlayerTurn();
            };
        } else {
            const btn = document.createElement("button");
            btn.innerText = "üóë";
            btn.className = "discard-btn";
            btn.onclick = () => discardOpponentCard(i);
            wrap.appendChild(btn);
        }

        wrap.appendChild(c);
        botDiv.appendChild(wrap);
    });
}

function attemptBotCardPlay(index, botCard) {
    const topDiscard = discardPile[discardPile.length - 1];
    if (!topDiscard) return log("‚ùå Il n'y a pas de carte dans la d√©fausse.");
    if (botCard === topDiscard) {
        log(`üéØ Bonne tentative ! Carte ${botCard} retir√©e du Bot. Vous lui donnez une de vos cartes.`);
        // Retirer la carte du bot
        discardPile.push(botCards[index]);
        // Donner au bot la derni√®re carte de la main du joueur
        if (playerCards.length > 0) {
            botCards[index] = playerCards.pop();
        } else {
            botCards[index] = CARD_POOL[Math.floor(Math.random() * CARD_POOL.length)];
        }
    } else {
        const penalty = CARD_POOL[Math.floor(Math.random() * CARD_POOL.length)];
        playerCards.push(penalty);
        log(`‚ùå Mauvaise tentative sur la carte de l'adversaire. Vous piochez une carte de p√©nalit√© (${penalty}).`);
    }
    renderCards();
}

function checkSpecialEffect(card) {
    if (card === 8 || card === "8") {
        log("üëÅÔ∏è Effet 8 activ√© : choisissez une de vos cartes √† r√©v√©ler.");
        specialAction = "revealSelf";
        document.getElementById("skip-special").style.display = "inline-block";
        renderCards();
        return;
    }
    if (card === 10 || card === "10") {
        log("üîé Effet 10 activ√© : choisissez une carte de l'adversaire √† regarder.");
        specialAction = "lookOpp";
        document.getElementById("skip-special").style.display = "inline-block";
        renderCards();
        return;
    }
    if (card === "V" || card === "J" || card === 11) {
        log("üîÑ Effet Valet activ√© : √©changez une de vos cartes avec une de celles de l'adversaire (√† l'aveugle).");
        specialAction = "swapJack";
        jackSwapSelectedIndex = null;
        document.getElementById("skip-special").style.display = "inline-block";
        renderCards();
        return;
    }
}

function discardOpponentCard(index) {
    const card = botCards[index];
    const topDiscard = discardPile[discardPile.length - 1];
    if (!topDiscard) return log("‚ùå Aucune carte dans la d√©fausse.");

    const normalize = (val) => typeof val === "number" ? val : isNaN(val) ? val : parseInt(val);
    if (normalize(card) === normalize(topDiscard)) {
        log(`üéØ Bonne d√©fausse ! La carte ${card} correspond √† la d√©fausse.`);
        discardPile.push(card);
        checkSpecialEffect(card); // et lui donner une de nos cartes (derni√®re)
        if (playerCards.length > 0) {
            botCards[index] = playerCards.pop();
        } else {
            botCards[index] = CARD_POOL[Math.floor(Math.random() * CARD_POOL.length)];
        }
    } else {
        const penalty = CARD_POOL[Math.floor(Math.random() * CARD_POOL.length)];
        playerCards.push(penalty);
        log(`‚ùå Mauvaise tentative. Vous piochez une p√©nalit√© (${penalty}).`);
    }
    renderCards();
}

function handleCardClick(index, card) {
    if (selectingInitialCards) return log("‚è≥ Termine d'abord ta s√©lection de cartes m√©moire.");
    if (specialAction === "revealSelf") {
        if (!revealedIndexes.includes(index)) {
            revealedIndexes.push(index);
            log(`üëÅÔ∏è Vous regardez votre carte : ${card}`);
        }
        specialAction = null;
        document.getElementById("skip-special").style.display = "none";
        renderCards();
        endPlayerTurn();
    } else if (specialAction === "swapJack") {
        jackSwapSelectedIndex = index;
        log(`üÉè Carte s√©lectionn√©e pour √©change avec le bot.`);
        document.querySelectorAll('.card').forEach(card => card.classList.remove('highlight-swap'));
        renderCards();
    } else if (drawnCard !== null) {
        attemptCardSwap(index);
    }
}

function updateTurn() {
    document.getElementById("turn-info").innerText = `Tour de ${currentPlayer}`;
}

function endPlayerTurn() {
    // Ne passer au bot que si aucune action sp√©ciale n'est en attente
    if (specialAction) {
        return;
    }
    currentPlayer = "Bot";
    updateTurn();
    // Petite pause avant que le bot joue
    setTimeout(botPlayTurn, 1000);
}

function botPlayTurn() {
    if (currentPlayer !== "Bot") return;
    log("ü§ñ Tour du Bot...");

    // Strat√©gie de base du Bot :
    // 1. Si la d√©fausse n'est pas vide, le Bot regarde la carte du dessus.
    // 2. Le Bot pioche une carte.
    // 3. Le Bot compare la carte pioch√©e avec sa main et la d√©fausse (pour l'instant, logique tr√®s simple).

    const topDiscardedCard = discardPile[discardPile.length - 1];
    if (topDiscardedCard) {
        log(`ü§ñ Le Bot regarde la d√©fausse :